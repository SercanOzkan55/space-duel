<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Neon Space Duel â€” AI</title>
  <style>
    :root{
      --bg:#020617;
      --text:#eaf7ff;
      --cyan:#00E5FF;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:
        radial-gradient(1200px 400px at 50% 10%, rgba(0,229,255,.12), transparent 60%),
        radial-gradient(900px 380px at 10% 20%, rgba(124,58,237,.10), transparent 60%),
        var(--bg);
      color:var(--text);
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    }
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    header{padding:8px 2px 10px}
    h1{
      margin:0;
      letter-spacing: 0.18em;
      font-size: 22px;
      color: var(--text);
      text-shadow: 0 0 18px rgba(0,229,255,.45);
    }
    .kbd{
      display:inline-block;
      padding:2px 8px;
      border:1px solid rgba(234,247,255,.25);
      border-radius:999px;
      margin-right:6px;
      font-size:12px;
    }
    .sep{opacity:.5;margin:0 10px}
    canvas{
      display:block;
      width:100%;
      border-radius: 18px;
      border: 1px solid rgba(234,247,255,.12);
      box-shadow: 0 0 30px rgba(0,229,255,.12), inset 0 0 30px rgba(0,229,255,.06);
      background: rgba(2,6,23,.35);
    }
    footer{padding:10px 2px;opacity:.85}

    .topbar{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      margin-top:10px;
      flex-wrap:wrap;
    }
    .help{opacity:.9}

    .btn{
      cursor:pointer;
      border:1px solid rgba(234,247,255,.18);
      background: rgba(0,229,255,.10);
      color: var(--text);
      border-radius:999px;
      padding:6px 12px;
      font: inherit;
      font-size:12px;
      transition: transform .06s ease, box-shadow .2s ease, background .2s ease;
      box-shadow: 0 0 18px rgba(0,229,255,.10);
      user-select:none;
    }
    .btn:hover{
      background: rgba(0,229,255,.16);
      box-shadow: 0 0 24px rgba(0,229,255,.16);
    }
    .btn:active{ transform: translateY(1px); }
    .btn.ghost{
      background: rgba(234,247,255,.06);
      box-shadow:none;
    }
    .btn.big{
      padding:10px 16px;
      font-size:13px;
    }

    .stage{position:relative}

    .overlay{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      backdrop-filter: blur(6px);
      background: rgba(2,6,23,.45);
      border-radius:18px;
      z-index:5;
    }
    .hidden{ display:none !important; }

    .panel{
      width:min(560px, 92%);
      border-radius:18px;
      border:1px solid rgba(234,247,255,.14);
      background: rgba(2,6,23,.70);
      box-shadow: 0 0 40px rgba(0,229,255,.18), inset 0 0 30px rgba(0,229,255,.06);
      padding:18px 16px 14px;
      text-align:center;
    }
    .resultTitle{
      letter-spacing:.18em;
      font-size:22px;
      margin-bottom:6px;
      text-shadow: 0 0 18px rgba(0,229,255,.45);
    }
    .resultTitle[data-type="lose"]{
      text-shadow: 0 0 18px rgba(255,61,129,.35);
    }
    .resultTitle[data-type="draw"]{
      text-shadow: 0 0 18px rgba(234,247,255,.25);
    }
    .resultSub{
      opacity:.85;
      margin-bottom:14px;
    }
    .panelBtns{
      display:flex;
      gap:10px;
      justify-content:center;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .tinyHint{
      margin-top:12px;
      opacity:.6;
      font-size:12px;
    }

    .menuRow{
      display:flex;
      gap:10px;
      justify-content:center;
      align-items:center;
      margin:14px 0 8px;
      flex-wrap:wrap;
    }
    .menuRow input{
      width:240px;
      max-width:78vw;
      outline:none;
      border:1px solid rgba(234,247,255,.14);
      background: rgba(2,6,23,.35);
      color: var(--text);
      border-radius:999px;
      padding:10px 12px;
      font: inherit;
      font-size:13px;
    }
    .menuRow input::placeholder{opacity:.55}

    .pillGroup{
      display:flex;
      gap:8px;
      justify-content:center;
      flex-wrap:wrap;
      margin-top:6px;
    }
    .pill{
      padding:6px 12px;
      border-radius:999px;
      border:1px solid rgba(234,247,255,.18);
      background: rgba(234,247,255,.06);
      opacity:.9;
    }
    .pill.active{
      background: rgba(0,229,255,.14);
      box-shadow: 0 0 18px rgba(0,229,255,.14);
      border-color: rgba(0,229,255,.32);
    }

    .pressEnter{
      margin-top:10px;
      letter-spacing:.18em;
      opacity:.85;
      font-size:12px;
      text-shadow: 0 0 18px rgba(0,229,255,.25);
      animation: blink 1.1s ease-in-out infinite;
    }
    @keyframes blink{
      0%,100%{opacity:.25}
      50%{opacity:.95}
    }

    .toggleRow{
      display:flex;
      justify-content:center;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
    }

    /* --- Podium (Top 3) --- */
    .podium{
      margin-top:14px;
      padding:12px 12px 10px;
      border:1px solid rgba(234,247,255,.12);
      border-radius:18px;
      background: rgba(2,6,23,.25);
      box-shadow: inset 0 0 22px rgba(0,229,255,.05);
    }
    .podiumTitle{
      letter-spacing:.18em;
      font-size:12px;
      opacity:.85;
      margin-bottom:10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .podiumRow{
      display:flex;
      justify-content:center;
      gap:10px;
      align-items:flex-end;
      flex-wrap:wrap;
    }
    .podiumCard{
      width: min(240px, 28vw);
      min-width: 170px;
      padding:10px 10px 12px;
      border-radius:16px;
      border:1px solid rgba(234,247,255,.12);
      background: rgba(2,6,23,.35);
      text-align:center;
    }
    .podiumCard .rank{
      font-size:12px;
      opacity:.8;
      margin-bottom:6px;
    }
    .podiumCard .name{
      font-size:14px;
      letter-spacing:.06em;
      margin-bottom:4px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .podiumCard .score{
      font-size:12px;
      opacity:.75;
    }
    .podiumCard.p1{
      transform: translateY(-14px);
      box-shadow: 0 0 26px rgba(0,229,255,.14);
      border-color: rgba(0,229,255,.22);
    }
    .podiumCard.p2{
      transform: translateY(-6px);
      box-shadow: 0 0 18px rgba(167,139,250,.10);
    }
    .podiumCard.p3{
      transform: translateY(-2px);
      box-shadow: 0 0 14px rgba(234,247,255,.08);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>NEON SPACE DUEL</h1>

      <div class="topbar">
        <div class="help">
          <span class="kbd">A / D</span> Move
          <span class="sep">|</span>
          <span class="kbd">Space</span> Jump
          <span class="sep">|</span>
          <span class="kbd">F</span> Shoot
        </div>

        <div class="help">
          <button id="musicBtn" class="btn">Music: ON</button>
          <span class="sep">|</span>
          <span class="kbd">Enter</span> Start
        </div>
      </div>
    </header>

    <div class="stage">
      <canvas id="c" width="980" height="420"></canvas>

      <!-- START MENU -->
      <div id="startMenu" class="overlay">
        <div class="panel">
          <div class="resultTitle">NEON SPACE DUEL</div>
          <div class="resultSub">Enter your name â€¢ choose difficulty â€¢ press Start</div>

          <div class="menuRow">
            <input id="menuName" maxlength="12" placeholder="Your name..." />
            <button id="startBtn" class="btn big">START</button>
          </div>

          <div class="pillGroup" aria-label="Difficulty">
            <button class="btn pill active" data-diff="easy">Easy</button>
            <button class="btn pill" data-diff="normal">Normal</button>
            <button class="btn pill" data-diff="hard">Hard</button>
          </div>

          <div class="toggleRow">
            <button id="startMusicBtn" class="btn">Music: ON</button>
          </div>

          <div class="pressEnter">PRESS ENTER</div>
          <div class="tinyHint">Tip: Jump dodges bullets. AI gets tougher on Hard ðŸ‘€</div>
        </div>
      </div>

      <!-- WIN/LOSE/DRAW OVERLAY -->
      <div id="overlay" class="overlay hidden">
        <div class="panel">
          <div id="resultTitle" class="resultTitle">YOU WIN</div>
          <div id="resultSub" class="resultSub">Score 0:0</div>
          <div class="panelBtns">
            <button id="restartBtn" class="btn big">Restart</button>
            <button id="closeBtn" class="btn ghost">Close</button>
          </div>
          <div class="tinyHint">Win on Hard for bigger points âœ¨</div>
        </div>
      </div>
    </div>

    <!-- PODIUM -->
    <div class="podium">
      <div class="podiumTitle">
        <span>TOP 3 (local)</span>
        <button id="resetBoard" class="btn ghost">Reset leaderboard</button>
      </div>
      <div class="podiumRow">
        <div class="podiumCard p2">
          <div class="rank">2</div>
          <div class="name" id="lb2n">â€”</div>
          <div class="score" id="lb2s">â€”</div>
        </div>

        <div class="podiumCard p1">
          <div class="rank">1</div>
          <div class="name" id="lb1n">â€”</div>
          <div class="score" id="lb1s">â€”</div>
        </div>

        <div class="podiumCard p3">
          <div class="rank">3</div>
          <div class="name" id="lb3n">â€”</div>
          <div class="score" id="lb3s">â€”</div>
        </div>
      </div>
    </div>

    <footer>
      <span id="status">First to 5 wins. No blood, just lasers âœ¨</span>
    </footer>
  </div>

<script>
(() => {
  const canvas = document.getElementById("c");
  const ctx = canvas.getContext("2d");

  const statusEl = document.getElementById("status");
  const overlay = document.getElementById("overlay");
  const resultTitle = document.getElementById("resultTitle");
  const resultSub = document.getElementById("resultSub");
  const restartBtn = document.getElementById("restartBtn");
  const closeBtn = document.getElementById("closeBtn");

  const startMenu = document.getElementById("startMenu");
  const startBtn = document.getElementById("startBtn");
  const menuName = document.getElementById("menuName");
  const diffBtns = Array.from(document.querySelectorAll("[data-diff]"));

  const musicBtn = document.getElementById("musicBtn");
  const startMusicBtn = document.getElementById("startMusicBtn");

  // HiDPI
  const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
  function resize() {
    const cssW = Math.min(980, window.innerWidth - 24);
    const cssH = Math.round(cssW * 0.43);
    canvas.style.width = cssW + "px";
    canvas.style.height = cssH + "px";
    canvas.width = Math.floor(cssW * dpr);
    canvas.height = Math.floor(cssH * dpr);
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  }
  window.addEventListener("resize", resize);
  resize();

  const W = () => parseInt(canvas.style.width);
  const H = () => parseInt(canvas.style.height);

  // Controls
  const keys = new Set();
  window.addEventListener("keydown", (e) => {
    const k = e.key.toLowerCase();
    keys.add(k);
    if (["arrowup","arrowdown","arrowleft","arrowright"," "].includes(e.key)) e.preventDefault();
  });
  window.addEventListener("keyup", (e) => keys.delete(e.key.toLowerCase()));

  // Stars
  const stars = Array.from({length: 140}, () => ({
    x: Math.random() * 980,
    y: Math.random() * 420,
    r: Math.random() * 1.6 + 0.2,
    s: Math.random() * 0.6 + 0.1
  }));

  const neon = {
    cyan: "#00E5FF",
    deep: "#06121f",
    white: "#eaf7ff",
    purple: "#A78BFA",
    red: "#FF3D81"
  };

  const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));

  // --- Leaderboard (localStorage) ---
  const LB_KEY = "nsd_leaderboard_v1";

  function loadLB(){
    try { return JSON.parse(localStorage.getItem(LB_KEY) || "[]"); }
    catch { return []; }
  }
  function saveLB(list){
    localStorage.setItem(LB_KEY, JSON.stringify(list));
  }
  function updatePodiumUI(){
    const lb = loadLB().sort((a,b)=>b.points-a.points).slice(0,3);

    const e1n = document.getElementById("lb1n");
    const e1s = document.getElementById("lb1s");
    const e2n = document.getElementById("lb2n");
    const e2s = document.getElementById("lb2s");
    const e3n = document.getElementById("lb3n");
    const e3s = document.getElementById("lb3s");

    const a1 = lb[0], a2 = lb[1], a3 = lb[2];

    e1n.textContent = a1 ? a1.name : "â€”";
    e1s.textContent = a1 ? `${a1.points} pts â€¢ ${a1.diff.toUpperCase()}` : "â€”";

    e2n.textContent = a2 ? a2.name : "â€”";
    e2s.textContent = a2 ? `${a2.points} pts â€¢ ${a2.diff.toUpperCase()}` : "â€”";

    e3n.textContent = a3 ? a3.name : "â€”";
    e3s.textContent = a3 ? `${a3.points} pts â€¢ ${a3.diff.toUpperCase()}` : "â€”";
  }
  function submitScore(name, points, diff, finalScore){
    const safeName = (name || "P1").trim().slice(0,20) || "P1";
    const lb = loadLB();

    lb.push({ name: safeName, points, diff, final: finalScore, t: Date.now() });

    // keep best per name only
    const best = new Map();
    for (const e of lb){
      const prev = best.get(e.name);
      if (!prev || e.points > prev.points) best.set(e.name, e);
    }
    saveLB(Array.from(best.values()));
    updatePodiumUI();
  }

  document.getElementById("resetBoard").addEventListener("click", ()=>{
    localStorage.removeItem(LB_KEY);
    updatePodiumUI();
  });

  // ---- Music (WebAudio - no external files) ----
  let audioCtx = null;
  let musicOn = true;
  let musicNodes = null;

  // âœ… must be declared BEFORE usage anywhere
  let roundOver = false;

  function ensureAudio() {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
  function stopMusic() {
    if (musicNodes) {
      try { musicNodes.osc1.stop(); } catch {}
      try { musicNodes.osc2.stop(); } catch {}
      try { musicNodes.lfo.stop(); } catch {}
      musicNodes = null;
    }
  }

  // nicer synthwave-ish loop
  function startMusic() {
    ensureAudio();
    if (audioCtx.state === "suspended") audioCtx.resume();
    stopMusic();

    const master = audioCtx.createGain();
    master.gain.value = 0.18;

    const comp = audioCtx.createDynamicsCompressor();
    comp.threshold.value = -18;
    comp.knee.value = 18;
    comp.ratio.value = 4;
    comp.attack.value = 0.01;
    comp.release.value = 0.18;

    const delay = audioCtx.createDelay(0.6);
    delay.delayTime.value = 0.22;

    const fb = audioCtx.createGain();
    fb.gain.value = 0.35;

    const hp = audioCtx.createBiquadFilter();
    hp.type = "highpass";
    hp.frequency.value = 180;

    delay.connect(fb);
    fb.connect(hp);
    hp.connect(delay);

    const lp = audioCtx.createBiquadFilter();
    lp.type = "lowpass";
    lp.frequency.value = 2400;

    master.connect(comp);
    comp.connect(lp);
    lp.connect(audioCtx.destination);

    const delaySend = audioCtx.createGain();
    delaySend.gain.value = 0.32;
    comp.connect(delaySend);
    delaySend.connect(delay);
    delay.connect(audioCtx.destination);

    const arp = audioCtx.createOscillator();
    arp.type = "square";
    const arpGain = audioCtx.createGain();
    arpGain.gain.value = 0.0;

    const arpFilter = audioCtx.createBiquadFilter();
    arpFilter.type = "bandpass";
    arpFilter.frequency.value = 900;
    arpFilter.Q.value = 6;

    arp.connect(arpFilter);
    arpFilter.connect(arpGain);
    arpGain.connect(master);

    const bass = audioCtx.createOscillator();
    bass.type = "sine";
    const bassGain = audioCtx.createGain();
    bassGain.gain.value = 0.0;
    bass.connect(bassGain);
    bassGain.connect(master);

    const kickGain = audioCtx.createGain();
    kickGain.gain.value = 0.0;
    kickGain.connect(master);

    const bpm = 112;
    const step = 60 / bpm / 4; // 16th
    let t = audioCtx.currentTime + 0.03;

    const seq = [
      0, 7, 10, 7,   0, 7, 12, 7,
      3, 7, 10, 7,   5, 7, 12, 7
    ];
    const baseHz = 220;
    let idx = 0;

    function pluck(g, time, amp) {
      g.cancelScheduledValues(time);
      g.setValueAtTime(0.0001, time);
      g.exponentialRampToValueAtTime(amp, time + 0.01);
      g.exponentialRampToValueAtTime(0.0001, time + 0.12);
    }

    function kick(time) {
      const o = audioCtx.createOscillator();
      o.type = "sine";
      const g = audioCtx.createGain();
      o.connect(g);
      g.connect(kickGain);

      o.frequency.setValueAtTime(140, time);
      o.frequency.exponentialRampToValueAtTime(45, time + 0.12);

      g.gain.setValueAtTime(0.0001, time);
      g.gain.exponentialRampToValueAtTime(0.9, time + 0.005);
      g.gain.exponentialRampToValueAtTime(0.0001, time + 0.18);

      o.start(time);
      o.stop(time + 0.2);
    }

    const stepsTotal = 16 * 4;
    for (let s = 0; s < stepsTotal; s++) {
      const semis = seq[idx % seq.length];
      const hz = baseHz * Math.pow(2, semis / 12);

      arp.frequency.setValueAtTime(hz, t);
      pluck(arpGain.gain, t, 0.11);

      if (s % 4 === 0) {
        const bassHz = baseHz * Math.pow(2, (semis - 24) / 12);
        bass.frequency.setValueAtTime(bassHz, t);
        pluck(bassGain.gain, t, 0.08);
      }

      if (s % 8 === 0) kick(t);

      t += step;
      idx++;
    }

    arp.start();
    bass.start();

    musicNodes = { osc1: arp, osc2: bass, lfo: { stop(){} }, master };
  }

  function setMusic(on) {
    musicOn = on;
    musicBtn.textContent = `Music: ${musicOn ? "ON" : "OFF"}`;
    startMusicBtn.textContent = `Music: ${musicOn ? "ON" : "OFF"}`;
    if (musicOn) startMusic(); else stopMusic();
  }
  musicBtn.addEventListener("click", () => setMusic(!musicOn));
  startMusicBtn.addEventListener("click", () => setMusic(!musicOn));

  // ---- Difficulty ----
  let difficulty = "easy";
  const DIFF = {
    easy:   { aiAgg: 0.45, aiDodge: 0.65, aiStrafe: 0.45, aiMaxV: 5.6, bonus: 0 },
    normal: { aiAgg: 0.65, aiDodge: 0.85, aiStrafe: 0.55, aiMaxV: 6.1, bonus: 200 },
    hard:   { aiAgg: 0.85, aiDodge: 0.95, aiStrafe: 0.70, aiMaxV: 6.5, bonus: 450 }
  };
  function setDifficulty(d) {
    difficulty = d;
    diffBtns.forEach(b => b.classList.toggle("active", b.dataset.diff === d));
  }
  diffBtns.forEach(b => b.addEventListener("click", () => setDifficulty(b.dataset.diff)));

  // Physics
  const groundY = () => H() - 18;

  function makePlayer(x, color, controls, isAI=false) {
    return {
      x, y: groundY(),
      vx: 0, vy: 0,
      w: 26, h: 46,

      hp: 100,
      score: 0,

      face: 1,
      color,

      cd: 0,
      jumpCd: 0,
      onGround: true,

      label: isAI ? "AI" : "P1",
      controls,
      isAI,

      ai: {
        jitter: 0,
        aggression: 0.65,
        dodge: 0.85,
        strafe: 0.55
      }
    };
  }

  const p1 = makePlayer(110, neon.cyan, {
    left:"a", right:"d", shoot:"f", jump:" "
  }, false);

  const bot = makePlayer(980-110, neon.purple, null, true);
  bot.face = -1;

  let playerName = "P1";

  const bullets = [];
  function shoot(p) {
    if (p.cd > 0) return;
    p.cd = 12;

    const speed = 9.5;
    const bx = p.x + p.face * (p.w/2 + 8);
    const by = p.y - p.h*0.55;

    bullets.push({
      x: bx, y: by,
      vx: p.face * speed,
      vy: 0,
      r: 3.2,
      life: 95,
      color: p.color,
      owner: p
    });
  }

  function jump(p) {
    if (!p.onGround) return;
    p.onGround = false;
    p.vy = -11.2;
  }

  function hideOverlay() { overlay.classList.add("hidden"); }
  function showOverlay(type) {
    overlay.classList.remove("hidden");

    if (type === "win") {
      resultTitle.textContent = "YOU WIN";
      resultTitle.dataset.type = "win";
    } else if (type === "lose") {
      resultTitle.textContent = "YOU LOSE";
      resultTitle.dataset.type = "lose";
    } else {
      resultTitle.textContent = "DRAW";
      resultTitle.dataset.type = "draw";
    }

    resultSub.textContent = `Final Score ${p1.score}:${bot.score} â€¢ ${difficulty.toUpperCase()}`;
  }

  function resetRound(winner) {
    roundOver = false;

    p1.x = 110; p1.y = groundY(); p1.vx = p1.vy = 0; p1.hp = 100; p1.face = 1; p1.cd = 0; p1.onGround = true;
    bot.x = W()-110; bot.y = groundY(); bot.vx = bot.vy = 0; bot.hp = 100; bot.face = -1; bot.cd = 0; bot.onGround = true;

    bullets.length = 0;

    if (winner) {
      winner.score++;
      statusEl.textContent = `Point for ${winner===p1 ? playerName : "AI"} â€” Score ${p1.score}:${bot.score}`;
    } else {
      statusEl.textContent = `First to 5 wins.`;
    }
  }

  function resetMatch() {
    p1.score = 0;
    bot.score = 0;
    hideOverlay();
    resetRound(null);
  }

  restartBtn.addEventListener("click", resetMatch);
  closeBtn.addEventListener("click", hideOverlay);

  function rectHitCircle(rx, ry, rw, rh, cx, cy, cr) {
    const px = clamp(cx, rx, rx+rw);
    const py = clamp(cy, ry, ry+rh);
    const dx = cx - px, dy = cy - py;
    return dx*dx + dy*dy <= cr*cr;
  }

  function updatePlayerHuman(p) {
    const acc = 0.72;
    const maxV = 6.6;
    const friction = 0.86;

    // ONLY: A/D move, Space jump, F shoot
    const L = keys.has("a");
    const R = keys.has("d");
    const S = keys.has("f");
    const J = keys.has(" ");

    if (L) p.vx -= acc;
    if (R) p.vx += acc;

    if (p.jumpCd > 0) p.jumpCd--;
    if (J && p.onGround && p.jumpCd === 0) {
      p.jumpCd = 10;
      jump(p);
    }

    p.vx *= friction;
    p.vx = clamp(p.vx, -maxV, maxV);

    if (!p.onGround) p.vy += 0.62;
    p.vy = clamp(p.vy, -12, 12);

    p.x += p.vx;
    p.y += p.vy;

    p.x = clamp(p.x, 18, W()-18);

    if (p.y >= groundY()) {
      p.y = groundY();
      p.vy = 0;
      p.onGround = true;
    }

    p.face = (bot.x > p.x ? 1 : -1);

    if (p.cd > 0) p.cd--;
    if (S) shoot(p);
  }

  function nearestThreatTo(p) {
    let best = null;
    let bestT = 1e9;
    for (const b of bullets) {
      if (b.owner === p) continue;
      const toward = Math.sign(b.vx) === Math.sign(p.x - b.x);
      if (!toward) continue;
      const dx = Math.abs(b.x - p.x);
      if (dx < bestT) { bestT = dx; best = b; }
    }
    return best;
  }

  function updateBotAI(p) {
    const target = p1;

    const cfg = DIFF[difficulty];
    p.ai.aggression = cfg.aiAgg;
    p.ai.dodge = cfg.aiDodge;
    p.ai.strafe = cfg.aiStrafe;

    const acc = 0.62;
    const maxV = cfg.aiMaxV;
    const friction = 0.88;

    const dist = target.x - p.x;
    p.face = (target.x > p.x ? 1 : -1);

    const desired = 280;
    const tooClose = Math.abs(dist) < desired * 0.75;
    const tooFar   = Math.abs(dist) > desired * 1.25;

    const threat = nearestThreatTo(p);
    const threatNear = threat && Math.abs(threat.x - p.x) < 140 && Math.abs(threat.y - p.y) < 70;

    let move = 0;
    if (tooClose) move = -Math.sign(dist);
    else if (tooFar) move = Math.sign(dist);
    else {
      p.ai.jitter += (Math.random() - 0.5) * 0.25;
      p.ai.jitter = clamp(p.ai.jitter, -1, 1);
      if (Math.random() < p.ai.strafe) move = Math.sign(p.ai.jitter);
    }

    if (threatNear && Math.random() < p.ai.dodge) {
      move = Math.sign((p.x - threat.x) || 1);
      if (p.onGround && Math.random() < 0.58) jump(p);
    }

    p.vx += move * acc;
    p.vx *= friction;
    p.vx = clamp(p.vx, -maxV, maxV);

    if (!p.onGround) p.vy += 0.62;
    p.vy = clamp(p.vy, -12, 12);

    p.x += p.vx;
    p.y += p.vy;

    p.x = clamp(p.x, 18, W()-18);

    if (p.y >= groundY()) {
      p.y = groundY();
      p.vy = 0;
      p.onGround = true;
    }

    const aimY = (target.y - target.h*0.55) - (p.y - p.h*0.55);
    const aligned = Math.abs(aimY) < 22;
    const hasLine = Math.abs(dist) < 520;
    const wants = Math.random() < (0.04 + 0.09*p.ai.aggression);

    if (p.cd > 0) p.cd--;
    if (aligned && hasLine && wants) shoot(p);
  }

  function calcPointsIfPlayerWins() {
    const diffBonus = DIFF[difficulty].bonus;
    const margin = (5 - bot.score);
    const hpBonus = Math.max(0, Math.round(p1.hp));
    return diffBonus + margin * 120 + hpBonus;
  }

  function updateBullets() {
    if (roundOver) return;

    for (let i = bullets.length - 1; i >= 0; i--) {
      const b = bullets[i];
      b.x += b.vx;
      b.y += b.vy;
      b.life--;

      if (b.life <= 0 || b.x < -60 || b.x > W() + 60) {
        bullets.splice(i, 1);
        continue;
      }

      const target = (b.owner === p1) ? bot : p1;
      const rx = target.x - target.w / 2;
      const ry = target.y - target.h;

      if (rectHitCircle(rx, ry, target.w, target.h, b.x, b.y, b.r + 2)) {
        target.hp -= 12;
        target.vx += Math.sign(b.vx) * 1.25;
        bullets.splice(i, 1);

        // DRAW check
        const pDead = (p1.hp <= 0);
        const bDead = (bot.hp <= 0);
        if (pDead && bDead) {
          roundOver = true;
          running = false;
          statusEl.textContent = `Match over â€” DRAW (${p1.score}:${bot.score})`;
          showOverlay("draw");
          return;
        }

        if (target.hp <= 0) {
          const winner = (target === p1) ? bot : p1;

          if (winner.score >= 4) {
            winner.score++;
            roundOver = true;
            running = false;

            statusEl.textContent = `Match over â€” Final ${p1.score}:${bot.score}`;

            const playerWon = (winner === p1);
            showOverlay(playerWon ? "win" : "lose");

            if (playerWon) {
              const pts = calcPointsIfPlayerWins();
              submitScore(playerName, pts, difficulty, `${p1.score}:${bot.score}`);
              statusEl.textContent =
                `Saved score: ${pts} pts â€” Final ${p1.score}:${bot.score} (${difficulty.toUpperCase()})`;
            }
          } else {
            resetRound(winner);
          }
        }
      }
    }
  }

  function glowLine(x1,y1,x2,y2,color,w=2) {
    ctx.save();
    ctx.strokeStyle = color;
    ctx.lineWidth = w;
    ctx.shadowColor = color;
    ctx.shadowBlur = 14;
    ctx.beginPath();
    ctx.moveTo(x1,y1);
    ctx.lineTo(x2,y2);
    ctx.stroke();
    ctx.restore();
  }

  function drawPlayer(p, label) {
    const x = p.x, y = p.y;
    const bodyTop = y - p.h;

    ctx.save();
    ctx.shadowColor = p.color;
    ctx.shadowBlur = 18;
    ctx.strokeStyle = p.color;
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.ellipse(x, y+2, 18, 7, 0, 0, Math.PI*2);
    ctx.stroke();
    ctx.restore();

    ctx.save();
    ctx.translate(x, bodyTop + 14);

    ctx.save();
    ctx.shadowColor = p.color;
    ctx.shadowBlur = 16;
    ctx.fillStyle = "rgba(234,247,255,0.07)";
    ctx.strokeStyle = p.color;
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.arc(0, 0, 10, 0, Math.PI*2);
    ctx.fill();
    ctx.stroke();
    ctx.restore();

    ctx.save();
    ctx.fillStyle = "rgba(0,229,255,0.10)";
    ctx.beginPath();
    ctx.ellipse(2, 1, 6, 4, 0.2, 0, Math.PI*2);
    ctx.fill();
    ctx.restore();

    ctx.save();
    ctx.strokeStyle = neon.white;
    ctx.globalAlpha = 0.8;
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(0, 10);
    ctx.lineTo(0, 26);
    ctx.stroke();
    ctx.restore();

    const armY = 16;
    const gunX = p.face * 14;
    glowLine(0, armY, gunX, armY, p.color, 2);

    ctx.save();
    ctx.strokeStyle = neon.white;
    ctx.globalAlpha = 0.7;
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(0, 26); ctx.lineTo(-7, 38);
    ctx.moveTo(0, 26); ctx.lineTo(7, 38);
    ctx.stroke();
    ctx.restore();

    ctx.save();
    ctx.fillStyle = neon.white;
    ctx.globalAlpha = 0.85;
    ctx.font = "12px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace";
    ctx.textAlign = "center";
    ctx.fillText(label, 0, -16);
    ctx.restore();

    if (p.hp <= 28) glowLine(-10, -10, 10, -10, neon.red, 2);

    ctx.restore();
  }

  function drawUI() {
    const barW = 220, barH = 10;
    function hpBar(x, y, hp, color) {
      ctx.save();
      ctx.fillStyle = "rgba(234,247,255,0.08)";
      ctx.fillRect(x, y, barW, barH);

      const ratio = clamp(hp/100,0,1);
      const glowColor = ratio < 0.3 ? neon.red : color;

      ctx.fillStyle = glowColor;
      ctx.shadowColor = glowColor;
      ctx.shadowBlur = 14;
      ctx.fillRect(x, y, barW * ratio, barH);
      ctx.restore();
    }
    hpBar(14, 14, p1.hp, p1.color);
    hpBar(W()-14-barW, 14, bot.hp, bot.color);

    ctx.save();
    ctx.fillStyle = neon.white;
    ctx.globalAlpha = 0.92;
    ctx.font = "14px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace";
    ctx.fillText(`${playerName} ${p1.score}`, 14, 46);
    ctx.textAlign = "right";
    ctx.fillText(`AI ${bot.score}`, W()-14, 46);
    ctx.restore();
  }

  function drawBackground(t) {
    const g = ctx.createLinearGradient(0,0,0,H());
    g.addColorStop(0, "#020617");
    g.addColorStop(1, neon.deep);
    ctx.fillStyle = g;
    ctx.fillRect(0,0,W(),H());

    for (const s of stars) {
      s.x -= s.s;
      if (s.x < -2) { s.x = W()+2; s.y = Math.random()*H(); }
      ctx.save();
      ctx.fillStyle = "rgba(234,247,255,0.7)";
      ctx.globalAlpha = 0.25 + 0.25*Math.sin((t*0.002)+(s.y*0.01));
      ctx.beginPath();
      ctx.arc(s.x*(W()/980), s.y*(H()/420), s.r, 0, Math.PI*2);
      ctx.fill();
      ctx.restore();
    }
    glowLine(0, H()-18, W(), H()-18, neon.cyan, 2);
  }

  function drawBullets() {
    for (const b of bullets) {
      ctx.save();
      ctx.fillStyle = b.color;
      ctx.shadowColor = b.color;
      ctx.shadowBlur = 18;
      ctx.beginPath();
      ctx.arc(b.x, b.y, b.r, 0, Math.PI*2);
      ctx.fill();
      glowLine(b.x, b.y, b.x - b.vx*2, b.y, b.color, 2);
      ctx.restore();
    }
  }

  // ---- Start / Running ----
  let running = false;

  function startGame(){
    if (musicOn) startMusic();

    const v = (menuName.value || "").trim();
    playerName = v.length ? v.slice(0,12) : "P1";

    startMenu.classList.add("hidden");
    hideOverlay();
    running = true;

    resetMatch();
    statusEl.textContent = `Good luck, ${playerName}! First to 5 wins. (${difficulty.toUpperCase()})`;
  }

  startBtn.addEventListener("click", startGame);
  window.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      if (!startMenu.classList.contains("hidden")) startGame();
    }
  });

  // ---- Initial ----
  setDifficulty("easy");
  setMusic(true);
  updatePodiumUI();

  // loop
  function loop(now) {
    drawBackground(now);

    if (running) {
      updatePlayerHuman(p1);
      updateBotAI(bot);
      updateBullets();
    }

    drawBullets();
    drawPlayer(p1, playerName);
    drawPlayer(bot, "AI");
    drawUI();

    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);
})();
</script>
</body>
</html>
